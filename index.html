<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Pomodoro Timer</title>

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
    /* --- CSS Variables for Theming --- */
    :root {
        --font-primary: 'Poppins', sans-serif;
        --font-logo: 'Pacifico', cursive;
        --color-bg: #f4f7fa;
        --color-surface: #ffffff;
        --color-text-primary: #1a202c;
        --color-text-secondary: #718096;
        --color-accent: #e53e3e; /* Red */
        --color-accent-dark: #c53030;
        --color-border: #e2e8f0;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --footer-bg: #1a202c;
        --footer-text: #a0aec0;
        --footer-heading: #edf2f7;
        --toggle-bg-off: #e53e3e;
        --toggle-bg-on: #ffffff;
        --color-accent-rgb: 229, 62, 62;
    }

    body.dark-mode {
        --color-bg: #1a202c;
        --color-surface: #2d3748;
        --color-text-primary: #edf2f7;
        --color-text-secondary: #a0aec0;
        --color-accent: #f56565; /* Lighter Red */
        --color-accent-dark: #e53e3e;
        --color-border: #4a5568;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.25);
        --footer-bg: #0f131a;
        --color-accent-rgb: 245, 101, 101;
    }

    /* --- General Styles --- */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body {
        font-family: var(--font-primary);
        background-color: var(--color-bg);
        color: var(--color-text-primary);
        display: flex;
        transition: background-color 0.3s, color 0.3s;
    }

    /* --- Sidebar --- */
    .sidebar {
        width: 240px; height: 100vh; background-color: var(--color-surface);
        border-right: 1px solid var(--color-border); padding: 2rem 1.5rem;
        display: flex; flex-direction: column; box-shadow: var(--shadow);
        position: fixed; transition: background-color 0.3s, border-color 0.3s; z-index: 10;
    }
    .sidebar .logo {
        font-family: var(--font-logo); font-size: 2.5rem; color: var(--color-accent);
        text-align: center; margin-bottom: 3rem;
    }
    .sidebar ul { list-style: none; }
    .sidebar ul li a {
        display: block; padding: 1rem; margin-bottom: 0.5rem; text-decoration: none;
        color: var(--color-text-secondary); font-weight: 600; border-radius: 8px;
        transition: background-color 0.2s, color 0.2s;
    }
    .sidebar ul li a:hover, .sidebar ul li a.active { background-color: var(--color-accent); color: white; }

    /* --- Main Content Area --- */
    .main-content {
        flex-grow: 1; margin-left: 240px;
        padding: 2rem 3rem; display: flex; flex-direction: column; min-height: 100vh;
    }
    main, section { flex-shrink: 0; }
    .page-content { flex-grow: 1; }

    header { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 2rem; }
    .dark-mode-switch { position: relative; display: inline-block; width: 60px; height: 34px; }
    .dark-mode-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--toggle-bg-off); transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--toggle-bg-on); }
    input:checked + .slider:before { transform: translateX(26px); background-color: var(--color-accent); }

    /* --- Generic Section Styles --- */
    .content-section { padding-top: 4rem; margin-top: -2rem; }
    .content-block { background-color: var(--color-surface); padding: 2rem; border-radius: 12px; box-shadow: var(--shadow); transition: background-color 0.3s; margin-bottom: 2rem; }
    .content-block h2 { color: var(--color-text-primary); margin-bottom: 1.5rem; }
    
    /* --- Auth Section Styles (NEW) --- */
    #auth-section input {
        width: 100%; max-width: 400px; padding: 0.75rem; margin-bottom: 1rem;
        border-radius: 6px; border: 1px solid var(--color-border);
        background-color: var(--color-bg); color: var(--color-text-primary); font-size: 1rem;
    }
    #auth-section input:focus {
        outline: none; border-color: var(--color-accent); box-shadow: 0 0 0 3px rgba(var(--color-accent-rgb), 0.3);
    }
    #auth-section .auth-buttons button {
        font-family: var(--font-primary); font-size: 1rem; font-weight: 600;
        padding: 0.75rem 1.5rem; margin-right: 1rem; margin-top: 0.5rem; border: none; border-radius: 8px;
        cursor: pointer; transition: all 0.2s;
    }
    #auth-section #loginBtn { background-color: var(--color-accent); color: white; }
    #auth-section #loginBtn:hover { background-color: var(--color-accent-dark); }
    #auth-section #signupBtn { background-color: var(--color-text-secondary); color: white; }
    #auth-section #signupBtn:hover { background-color: #4a5568; }
    #authStatus { margin-top: 1.5rem; font-weight: 600; min-height: 24px; color: var(--color-text-primary); }
    .welcome-name { font-family: var(--font-logo); color: var(--color-accent); font-size: 1.3em; }

    /* --- Timer Section --- */
    #timer-display { font-size: 10rem; font-weight: 700; text-align: center; color: var(--color-text-primary); line-height: 1; margin-bottom: 2rem; }
    .timer-controls { max-width: 500px; margin: 0 auto; }
    .time-setter { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
    #time-input { width: 100px; text-align: center; }
    #time-input, #time-unit-select { padding: 0.5rem; border-radius: 6px; border: 1px solid var(--color-border); background-color: var(--color-bg); color: var(--color-text-primary); font-size: 1rem; font-weight: 600; }
    .buttons { display: flex; justify-content: center; gap: 1rem; transform: translateX(8px); } /* Minor shift to the right */
    .buttons button { font-family: var(--font-primary); font-size: 1.1rem; font-weight: 600; padding: 0.8rem 2rem; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
    #start-pause-btn { background-color: var(--color-accent); color: white; }
    #reset-btn { background-color: var(--color-text-secondary); color: white; }

    /* --- Statistics Section CSS --- */
    .column-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; margin-bottom: 1rem; border-bottom: 2px solid var(--color-border); }
    .column-header h2 { user-select: none; cursor: pointer; position: relative; }
    .column-header h2::after { content: ' ▼'; font-size: 0.7em; display: inline-block; transition: transform 0.3s ease; }
    .column-header h2.collapsed::after { transform: rotate(-90deg); }
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
    .placeholder-text { color: var(--color-text-secondary); }
    #session-list-container { max-height: 265px; overflow-y: auto; transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out; }
    .session-item { display: flex; justify-content: space-between; padding: 1rem; border-bottom: 1px solid var(--color-border); cursor: pointer; transition: background-color 0.2s; }
    .session-item:hover { background-color: rgba(var(--color-accent-rgb), 0.1); }
    .chart-container { height: 250px; display: flex; gap: 10px; align-items: flex-end; justify-content: center; padding: 1rem 0; }
    .chart-bar {
        width: 100%;
        background: linear-gradient(180deg, var(--color-accent-dark) 0%, gold 100%);
        border-radius: 4px 4px 0 0;
        transition: all 0.3s ease-out;
        cursor: pointer;
    }
    .chart-bar:hover { transform: scaleY(1.05); }
    .chart-bar.highlighted {
        transform: scale(1.1);
        box-shadow: 0 0 12px 3px var(--color-accent);
    }
    
    /* --- Benefits Section --- */
    #benefits-section .section-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--color-border); }
    #benefits-section .section-header h2 { flex-grow: 1; border: none; margin: 0; padding-bottom: 1rem; }
    .translate-button { padding: 0.6rem 1.2rem; border: 1px solid var(--color-border); background-color: transparent; color: var(--color-text-secondary); font-family: var(--font-primary); font-weight: 600; border-radius: 6px; cursor: pointer; transition: all 0.2s; min-width: 120px; text-align: center; }
    .translate-button:hover { background-color: var(--color-accent); color: white; border-color: var(--color-accent); }
    #benefits-section p { font-size: 1.1rem; line-height: 1.8; color: var(--color-text-secondary); margin-bottom: 1rem; margin-top: 1.5rem;}
    .content-block.rtl { direction: rtl; text-align: right; }
    
    /* --- FOOTER STYLES --- */
    .site-footer { background-color: var(--footer-bg); color: var(--footer-text); padding: 3rem 2rem; margin-top: 4rem; }
    .footer-content { display: flex; justify-content: space-between; flex-wrap: wrap; gap: 2rem; max-width: 1200px; margin: 0 auto; }
    .footer-brand .logo { font-family: var(--font-logo); font-size: 2.5rem; color: var(--color-accent); margin-bottom: 1rem; }
    .footer-links { display: flex; gap: 4rem; }
    .footer-column h4 { color: var(--footer-heading); margin-bottom: 1.5rem; }
    .footer-column ul { list-style: none; }
    .footer-column ul a { text-decoration: none; color: var(--footer-text); }
    .footer-bottom { text-align: center; margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--color-border); }

    /* --- Responsive Design --- */
    @media (max-width: 1024px) { .stats-grid { grid-template-columns: 1fr; } .footer-content { flex-direction: column; text-align: center; } }
    @media (max-width: 768px) { body { flex-direction: column; } .sidebar { width: 100%; height: auto; flex-direction: row; justify-content: space-between; } .sidebar .logo { margin-bottom: 0; } .sidebar ul { display: flex; } .main-content { margin-left: 0; padding: 1rem; } #timer-display { font-size: 6rem; } }
</style>
</head>
<body class="dark-mode">

<!-- Left Sidebar -->
<nav class="sidebar">
    <h1 class="logo">Pomodoro</h1>
    <ul>
        <li><a href="#timer-section" class="nav-link active">Timer</a></li>
        <li><a href="#stats-section" class="nav-link">Statistics</a></li>
        <li><a href="#benefits-section" class="nav-link">Benefits</a></li>
        <li><a href="#auth-section" class="nav-link">Account</a></li>
    </ul>
</nav>

<!-- Main Content -->
<div class="main-content">
    <div class="page-content">
        <!-- Header with Dark Mode Toggle -->
        <header>
            <label class="dark-mode-switch">
                <input type="checkbox" id="darkModeToggle" checked>
                <span class="slider"></span>
            </label>
        </header>

        <!-- Timer Section -->
        <main id="timer-section" class="content-section">
            <div id="timer-display">25:00</div>
            <div class="timer-controls content-block">
                <div class="time-setter">
                    <label for="time-input">Set Time:</label>
                    <input type="number" id="time-input" value="25" min="1">
                    <select id="time-unit-select">
                        <option value="minutes" selected>Minutes</option>
                        <option value="hours">Hours</option>
                        <option value="seconds">Seconds</option>
                    </select>
                </div>
                <div class="buttons">
                    <button id="start-pause-btn">Start</button>
                    <button id="reset-btn">Reset</button>
                </div>
            </div>
        </main>
        
        <!-- Statistics Section -->
        <section id="stats-section" class="content-section">
            <div class="content-block">
                <div class="stats-grid" id="stats-grid-container">
                    <div>
                        <div class="column-header">
                            <h2 id="session-history-toggle">Session History</h2>
                        </div>
                        <div id="session-list-container">
                           <p class="placeholder-text">No completed sessions yet.</p>
                        </div>
                    </div>
                    <div>
                        <div class="column-header">
                            <h2>Session Graph</h2>
                        </div>
                        <div id="session-chart-container" class="chart-container">
                           <p class="placeholder-text" style="text-align:center; width: 100%;">Complete a session to see the chart.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Benefits Section -->
        <section id="benefits-section" class="content-section">
            <div class="content-block">
                <div class="section-header">
                    <h2 data-translate-key="benefitsTitle">The Power of the Pomodoro Technique</h2>
                    <button id="translate-btn" class="translate-button">للعربية</button>
                </div>
                <p data-translate-key="benefitsIntro">The Pomodoro Technique is a time management method that uses a timer to break work into intervals, traditionally 25 minutes in length, separated by short breaks. Each interval is known as a pomodoro. Here are some of its key benefits:</p>
                <p data-translate-key="benefitsFocus"><strong>Improves Focus:</strong> By dedicating a set amount of time to a single task, you train your brain to resist distractions and maintain deep concentration.</p>
                <p data-translate-key="benefitsBurnout"><strong>Reduces Burnout:</strong> Regular, short breaks are built into the system, allowing your mind to rest and recharge. This prevents mental fatigue and keeps you motivated throughout the day.</p>
                <p data-translate-key="benefitsAccountability"><strong>Increases Accountability:</strong> The timer creates a sense of urgency and helps you track exactly where your time is going, making it easier to plan your work and stay on schedule.</p>
            </div>
        </section>

        <!-- NEW: Account Section (Redesigned with Username) -->
        <section id="auth-section" class="content-section">
            <div class="content-block">
                <h2>Login or Create Account</h2>
                <input type="text" id="authUsername" placeholder="Username (for new accounts)"><br>
                <input type="email" id="authEmail" placeholder="Email"><br>
                <input type="password" id="authPassword" placeholder="Password"><br>
                <div class="auth-buttons">
                    <button id="loginBtn">Login</button>
                    <button id="signupBtn">Sign Up</button>
                </div>
                <div id="authStatus"></div>
            </div>
        </section>
    </div>

    <!-- FOOTER -->
    <footer class="site-footer">
        <div class="footer-content">
            <div class="footer-brand"> <div class="logo">Pomodoro</div> <p>A simple, modern tool to help you focus and boost productivity.</p> </div>
            <div class="footer-links">
                <div class="footer-column"> <h4>Navigation</h4> <ul> <li><a href="#timer-section">Timer</a></li> <li><a href="#stats-section">Statistics</a></li> <li><a href="#benefits-section">Benefits</a></li> <li><a href="#auth-section">Account</a></li> </ul> </div>
                <div class="footer-column"> <h4>Resources</h4> <ul> <li><a href="https://en.wikipedia.org/wiki/Pomodoro_Technique" target="_blank" rel="noopener noreferrer">About the Technique</a></li> </ul> </div>
                <div class="footer-column"> <h4>Connect</h4> <ul> <li><a href="https://github.com/SnipTech1" target="_blank" rel="noopener noreferrer">GitHub</a></li> <li><a href="mailto:saidzahran68@gmail.com">Contact</a></li> </ul> </div>
            </div>
        </div>
        <div class="footer-bottom"> Copyright © <span id="copyright-year"></span> <a href="https://github.com/SnipTech1/https-studywithmi" target="_blank" rel="noopener noreferrer">sniptech1</a>. All rights reserved. </div>
    </footer>
</div>

<!-- Firebase SDKs (using compat for older syntax) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<!-- Combined JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', () => {

    // =======================================================
    // FIREBASE SETUP AND FUNCTIONS
    // =======================================================
    const firebaseConfig = {
        apiKey: "AIzaSyDVlfLLOZ9By79kY1L4-lonTgCUY-9-1tA",
        authDomain: "pomodoto-app.firebaseapp.com",
        projectId: "pomodoto-app",
        storageBucket: "pomodoto-app.appspot.com",
        messagingSenderId: "600106546191",
        appId: "1:600106546191:web:8690663f9c2a9484b39f7a"
    };

    try {
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const authUsernameInput = document.getElementById("authUsername");
        const authEmailInput = document.getElementById("authEmail");
        const authPasswordInput = document.getElementById("authPassword");
        const loginBtn = document.getElementById("loginBtn");
        const signupBtn = document.getElementById("signupBtn");
        const authStatusDiv = document.getElementById("authStatus");

        function signup() {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            const username = authUsernameInput.value;
            if (!email || !password || !username) {
                alert("Please fill in Username, Email, and Password to sign up.");
                return;
            }
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    authStatusDiv.innerHTML = `✅ Hello, <span class="welcome-name">${username}</span>! Account created.`;
                    return db.collection("users").doc(user.uid).set({
                        username: username,
                        email: user.email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .catch((error) => { alert("❌ " + error.message); });
        }

        function login() {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            if (!email || !password) {
                alert("Please enter Email and Password to log in.");
                return;
            }
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    return db.collection("users").doc(user.uid).get();
                })
                .then((doc) => {
                    if (doc.exists) {
                        const username = doc.data().username;
                        authStatusDiv.innerHTML = `✅ Welcome back, <span class="welcome-name">${username}</span>!`;
                    } else {
                        authStatusDiv.innerText = `✅ Logged in successfully as ${authEmailInput.value}`;
                    }
                })
                .catch((error) => { alert("❌ " + error.message); });
        }

        loginBtn.addEventListener('click', login);
        signupBtn.addEventListener('click', signup);

    } catch (e) {
        console.error("Firebase initialization failed:", e);
        document.getElementById("authStatus").innerText = "Error: Could not connect to authentication service. Check Firebase config and console settings.";
    }

    // =======================================================
    // ORIGINAL POMODORO APP LOGIC
    // =======================================================
    const timerDisplay = document.getElementById('timer-display');
    const startPauseBtn = document.getElementById('start-pause-btn');
    const resetBtn = document.getElementById('reset-btn');
    const timeInput = document.getElementById('time-input');
    const timeUnitSelect = document.getElementById('time-unit-select');
    const darkModeToggle = document.getElementById('darkModeToggle');
    const copyrightYear = document.getElementById('copyright-year');
    const translateBtn = document.getElementById('translate-btn');
    const benefitsContentBlock = document.querySelector('#benefits-section .content-block');
    const elementsToTranslate = benefitsContentBlock.querySelectorAll('[data-translate-key]');
    const sessionListContainer = document.getElementById('session-list-container');
    const sessionChartContainer = document.getElementById('session-chart-container');
    const sessionHistoryToggle = document.getElementById('session-history-toggle');
    const statsSection = document.getElementById('stats-section');
    
    let timerInterval = null;
    let totalSeconds = 25 * 60;
    let secondsRemaining = totalSeconds;
    let isPaused = true;
    const alarmSound = new Audio('https://www.soundjay.com/buttons/sounds/button-16.mp3');

    const translations = {
        en: { benefitsTitle: 'The Power of the Pomodoro Technique', benefitsIntro: 'The Pomodoro Technique is a time management method...', benefitsFocus: '<strong>Improves Focus:</strong>...', benefitsBurnout: '<strong>Reduces Burnout:</strong>...', benefitsAccountability: '<strong>Increases Accountability:</strong>...' },
        ar: { benefitsTitle: 'قوة تقنية البومودورو', benefitsIntro: 'تقنية البومودورو هي طريقة لإدارة الوقت...', benefitsFocus: '<strong>تحسين التركيز:</strong>...', benefitsBurnout: '<strong>تقليل الإرهاق:</strong>...', benefitsAccountability: '<strong>زيادة المساءلة:</strong>...' }
    };
    let currentLang = 'en';
    if (translateBtn) {
        translateBtn.addEventListener('click', () => {
            currentLang = currentLang === 'en' ? 'ar' : 'en';
            benefitsContentBlock.classList.toggle('rtl', currentLang === 'ar');
            translateBtn.textContent = currentLang === 'en' ? 'للعربية' : 'English';
            elementsToTranslate.forEach(element => {
                const key = element.dataset.translateKey;
                if (key === "benefitsTitle") element.innerHTML = translations[currentLang].benefitsTitle;
            });
        });
    }

    const updateDisplay = () => {
        const minutes = Math.floor(secondsRemaining / 60);
        const seconds = secondsRemaining % 60;
        const displayString = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        timerDisplay.textContent = displayString;
        document.title = `${displayString} - Pomodoro`;
    };

    const resetTimer = () => {
        clearInterval(timerInterval);
        isPaused = true;
        startPauseBtn.textContent = 'Start';
        const timeValue = parseInt(timeInput.value, 10);
        const timeUnit = timeUnitSelect.value;
        switch (timeUnit) {
            case 'hours': totalSeconds = timeValue * 3600; break;
            case 'seconds': totalSeconds = timeValue; break;
            case 'minutes':
            default: totalSeconds = timeValue * 60; break;
        }
        secondsRemaining = totalSeconds;
        updateDisplay();
    };
    
    const pauseTimer = () => {
        clearInterval(timerInterval);
        isPaused = true;
        startPauseBtn.textContent = 'Start';
    };

    const startTimer = () => {
        if (!isPaused) return;
        isPaused = false;
        startPauseBtn.textContent = 'Pause';
        timerInterval = setInterval(() => {
            secondsRemaining--;
            updateDisplay();
            if (secondsRemaining < 0) {
                clearInterval(timerInterval);
                alarmSound.play();
                logCompletedSession(totalSeconds); 
                alert(`Congratulations! You've completed your session.`);
                resetTimer();
            }
        }, 1000);
    };

    const renderStatistics = () => {
        const allStats = JSON.parse(localStorage.getItem('pomodoro-stats')) || [];
        sessionListContainer.innerHTML = '';
        sessionChartContainer.innerHTML = '';

        if (allStats.length === 0) {
            sessionListContainer.innerHTML = '<p class="placeholder-text">No completed sessions yet.</p>';
            sessionChartContainer.innerHTML = '<p class="placeholder-text" style="text-align:center; width: 100%;">Complete a session to see the chart.</p>';
            return;
        }

        const sessionsForChart = allStats.slice(-10);
        const chartMaxDuration = 21600; // 6 hours in seconds

        allStats.slice().reverse().forEach(session => {
            const sessionId = session.date;
            const date = new Date(sessionId);
            const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            const durationInMinutes = Math.round(session.duration / 60);
            const listItem = document.createElement('div');
            listItem.className = 'session-item';
            listItem.dataset.sessionId = sessionId;
            listItem.innerHTML = `<span>${formattedDate}</span><span>${durationInMinutes} min</span>`;
            
            listItem.addEventListener('click', () => {
                statsSection.scrollIntoView({ behavior: 'smooth' });

                document.querySelectorAll('.chart-bar.highlighted').forEach(b => b.classList.remove('highlighted'));
                
                const targetBar = document.querySelector(`.chart-bar[data-session-id="${sessionId}"]`);
                if(targetBar) {
                    targetBar.classList.add('highlighted');
                }
            });
            
            sessionListContainer.appendChild(listItem);
        });

        sessionsForChart.forEach(session => {
            const sessionId = session.date;
            const barHeightPercentage = Math.min((session.duration / chartMaxDuration) * 100, 100);
            const bar = document.createElement('div');
            const durationInMinutes = Math.round(session.duration / 60);
            bar.className = 'chart-bar';
            bar.dataset.sessionId = sessionId;
            bar.style.height = `${Math.max(barHeightPercentage, 2)}%`;
            bar.title = `${durationInMinutes} minutes`;
            sessionChartContainer.appendChild(bar);
        });
    };

    const logCompletedSession = (durationInSeconds) => {
        const stats = JSON.parse(localStorage.getItem('pomodoro-stats')) || [];
        stats.push({ date: new Date().toISOString(), duration: durationInSeconds });
        localStorage.setItem('pomodoro-stats', JSON.stringify(stats));
        renderStatistics();
    };

    // Event Listeners
    startPauseBtn.addEventListener('click', () => isPaused ? startTimer() : pauseTimer());
    resetBtn.addEventListener('click', resetTimer);
    timeInput.addEventListener('change', resetTimer);
    timeUnitSelect.addEventListener('change', resetTimer);
    
    if (sessionHistoryToggle && sessionListContainer) {
        sessionHistoryToggle.addEventListener('click', () => {
            const isCollapsed = sessionListContainer.style.maxHeight === '0px';
            sessionHistoryToggle.classList.toggle('collapsed', !isCollapsed);
            if (isCollapsed) {
                sessionListContainer.style.maxHeight = sessionListContainer.scrollHeight + "px";
            } else {
                sessionListContainer.style.maxHeight = '0px';
            }
        });
    }

    const applyTheme = (theme) => {
        if (theme === 'dark') {
            document.body.classList.add('dark-mode');
            darkModeToggle.checked = true;
        } else {
            document.body.classList.remove('dark-mode');
            darkModeToggle.checked = false;
        }
        localStorage.setItem('pomodoro-theme', theme);
    };

    darkModeToggle.addEventListener('change', () => {
        applyTheme(darkModeToggle.checked ? 'dark' : 'light');
    });

    // Initialization
    const init = () => {
        if(copyrightYear) copyrightYear.textContent = new Date().getFullYear();
        const savedTheme = localStorage.getItem('pomodoro-theme');
        if (savedTheme) {
            applyTheme(savedTheme);
        } else {
            applyTheme('dark'); // Default to dark mode
        }
        resetTimer();
        renderStatistics();
    };

    init();
});
</script>

</body>
</html>
